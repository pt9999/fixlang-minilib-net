module RouterTest;

import HashMap;

import Minilib.Net.Router;
import Minilib.Testing.UnitTest;

create_simple_router: () -> Router String;
create_simple_router = |_| (
    let router: Router String = Router::empty;
    let router = router.insert("GET", "/", "index");
    let router = router.insert("GET", "/users", "users");
    let router = router.insert("POST", "/users", "users-post");
    let router = router.insert("GET", "/users/1", "users-1");
    router
);

test_router_find: TestCase;
test_router_find = (
    make_table_test("test_router_find",
        [
            ("", "", none()),
            ("XXX", "", none()),
            ("GET", "", some("index")),
            ("GET", "/", some("index")),
            ("GET", "//", some("index")),
            ("POST", "", none()),
            ("GET", "xxx", none()),
            ("GET", "users", some("users")),
            ("GET", "/users", some("users")),
            ("GET", "//users//", some("users")),
            ("GET", "/users/1", some("users-1")),
            ("GET", "//users//1//", some("users-1")),
            ("POST", "/users", some("users-post")),
            ("POST", "/users/1", none()),
        ],
        |(method, path, expected)|
        let router = create_simple_router();
        let actual = router.find(method, path);
        assert_equal("eq", expected, actual)
    )
);

main: IO ();
main = (
    [
        test_router_find,
        TestCase::empty
    ]
    .run_test_driver
);

